#merging occurrences downloaded for each species from obis and gbif
library(dplyr)
library(readr)
library(raster)
library(terra)
library(purrr)

#import the pccurrences from obis

# Define base folder
folder_path <- "C:/Users/x/smallpelloccurrences/obis"

# Find all .tsv files (recursively, including subfolders)
tsv_files <- list.files(folder_path, pattern = "\\.tsv$", full.names = TRUE, recursive = TRUE)

all_occurrences <- map_dfr(
  tsv_files,
  ~ readr::read_tsv(
    .x,
    show_col_types = FALSE,
    progress = FALSE,
    col_types = cols(.default = col_character()),
    trim_ws = TRUE
  ),
  .id = "source_file"
)


# Check result
all_occurrences %>%
  group_by(originalScientificName) %>%
  summarise(count = n())

rough_obis <- all_occurrences

rough_obis <- all_occurrences %>%
  dplyr::select(bathymetry,
         class,
         date_end,
         date_mid,
         date_start,
         date_year,
         day,
         decimalLatitude,
         decimalLongitude,
         depth,
         eventDate,
         family,
         genus,
         occurrenceID,
         scientificName,
         occurrenceStatus,
         species,
         absence)
#check for synonymz
rough_obis %>%
  group_by(scientificName) %>%
  summarise(count = n())

#import from gbif

#import all dowloaded csv files from GBIF
file_paths <- list.files(path = "C:/Users/x/gbif", pattern = "*.csv", full.names = TRUE)
data_list <- lapply(file_paths, read_delim, delim = "\t", escape_double = FALSE,  trim_ws = TRUE)

#keep only data columns of interest, merge all files into one data frame
selected_data_list <- lapply(data_list[1:19], function(df) df[c("species", "decimalLatitude", "decimalLongitude")])
gbifdf <- bind_rows(selected_data_list)

#rename columns
gbifdf <- gbifdf %>%
  rename(lat = decimalLatitude, lon = decimalLongitude, species= species)

gbifdf %>%
  group_by(species) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

#homogenise data column names from obis dataframe
rough_obis <- rough_obis %>%
  rename(lat = decimalLatitude, lon = decimalLongitude)

#merge the two dataframes
#rough_go <- merge(rough_obis,gbifdf, by = c("species", "lat", "lon"), all = TRUE)
rough_go <- rbind(
  rough_obis[, c("species", "lat", "lon")],
  gbifdf[, c("species", "lat", "lon")]
)

df<-rough_go
#make sure latitude and longitude values are numeric
df$lon <- as.double(df$lon)
df$lat <- as.double(df$lat)

#inspect data for discrepancies (in species name) and correct if necessary
unique_values <- unique(df$species)
print(unique_values)

#delete incomplete entries: before 762152, after 761068
df <- df[complete.cases(df$lat, df$lon), ]
#delete duplicate entries
df <- unique(df)
#761068 to 50316

#replace space in species names by underscore for practicality
df$species <- gsub(" ", "_", df$species)

#filter out for land occurrences, using a marine environment raster 
file_path <- "C:/Users/elili/Downloads/wc2.1_30s_bioc_INM-CM5-0_ssp585_2061-2080.tif"
oceanrast <- raster(file_path)
oceanrast <- terra::rast(oceanrast)
extracted_values <- extract(oceanrast, cbind(df$lon, df$lat))
df <- df[extracted_values != 0, ]

write.csv(df, "C:/Users/x/smallpelloccdf.csv", row.names = FALSE)

